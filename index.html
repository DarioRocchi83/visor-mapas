<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visor de Mapas Definitivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // CAMBIO CLAVE: Usamos window.onload en lugar de DOMContentLoaded.
        // Esto espera a que TODAS las librerías de arriba estén 100% cargadas.
        window.onload = function () {
            console.log("Página y TODAS las librerías cargadas. Construyendo el mapa...");

            // --- CONFIGURACIÓN ---
            const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHJ1KkaF4pZ-TzAUIUx_pQa97eKT6fp-T_5fIxevgrHUca-arFLQzYnxPY9jXM5Ow567TjX3NGYlyj/pub?gid=0&single=true&output=csv';
            const rutaKMZ = 'data/archivo1.kmz';

            // --- MAPA BASE ---
            const map = L.map('map').setView([-34.5, -64], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            const capasParaAjuste = L.featureGroup().addTo(map);

            // --- CARGAR KMZ ---
            try {
                omnivore.kmz(rutaKMZ)
                    .on('ready', function() {
                        capasParaAjuste.addLayer(this);
                        if (capasParaAjuste.getLayers().length > 0) map.fitBounds(capasParaAjuste.getBounds());
                        console.log("ÉXITO: Capa KMZ cargada.");
                    })
                    .on('error', function(e) {
                         console.error("ERROR KMZ: No se pudo cargar el archivo. Revisa que 'data/archivo1.kmz' exista en GitHub.", e);
                         alert("ALERTA: No se pudo cargar la capa KMZ.");
                    })
                    .addTo(map);
            } catch (error) {
                console.error("FALLO CRÍTICO OMNIVORE:", error);
                alert("FALLO CRÍTICO: La librería 'omnivore' no pudo inicializarse.");
            }

            // --- CARGAR GOOGLE SHEET ---
            Papa.parse(googleSheetURL, {
                download: true, header: true,
                complete: function (results) {
                    if (!results.data || results.data.length === 0) {
                        console.warn("AVISO: El Google Sheet está vacío o tiene un formato incorrecto.");
                        return;
                    }
                    results.data.forEach(function (fila) {
                        if (fila.Latitud && fila.Longitud) {
                            const lat = parseFloat(fila.Latitud.replace(',', '.'));
                            const lon = parseFloat(fila.Longitud.replace(',', '.'));
                            const popupContent = `<b>Orden:</b> ${fila['Numero de orden'] || 'N/A'}<br><b>Expediente:</b> ${fila.Expediente || 'N/A'}`;
                            const marker = L.marker([lat, lon]).bindPopup(popupContent);
                            capasParaAjuste.addLayer(marker);
                        }
                    });
                    if (capasParaAjuste.getLayers().length > 0) map.fitBounds(capasParaAjuste.getBounds());
                    console.log("ÉXITO: Puntos de Google Sheet cargados.");
                },
                error: err => console.error("ERROR GOOGLE SHEET: No se pudo descargar o analizar la URL.", err)
            });

            // --- HERRAMIENTAS ---
            new L.Control.Measure({ position: 'topright', localization: 'es' }).addTo(map);
            new L.Control.Draw({ edit: { featureGroup: new L.FeatureGroup().addTo(map) } }).addTo(map);
            L.Routing.control({ language: 'es', geocoder: L.Control.Geocoder.nominatim() }).addTo(map);
            console.log("Todas las herramientas añadidas.");
        };
    </script>
</body>
</html>